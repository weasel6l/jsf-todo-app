<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JSF Todo App - 一覧</title>
    <h:outputStylesheet library="css" name="todo.css"/>
</h:head>
<h:body>
    <div class="container">
        <header>
            <h1>&#128203; JSF Todo App</h1>
            <p class="subtitle">FlashContainer を活用した状態管理</p>
        </header>

        <!-- グローバルメッセージ (Flash から復元されたメッセージを含む) -->
        <h:messages globalOnly="true" styleClass="messages" showDetail="true"/>

        <!-- 統計バッジ -->
        <div class="stats">
            <span class="stat-badge total">合計: #{todoBean.todoList.size()}</span>
            <span class="stat-badge completed">完了: #{todoBean.completedCount}</span>
            <span class="stat-badge pending">未完了: #{todoBean.pendingCount}</span>
        </div>

        <!-- ── Todo 追加フォーム ── -->
        <section class="card add-section">
            <h2>&#10010; 新しい Todo を追加</h2>
            <h:form id="addForm">
                <div class="form-group">
                    <h:outputLabel for="newTitle" value="タイトル *" styleClass="label"/>
                    <h:inputText id="newTitle"
                                 value="#{todoBean.newTitle}"
                                 placeholder="例: 買い物をする"
                                 styleClass="input-field"
                                 maxlength="100"/>
                    <h:message for="newTitle" styleClass="error-msg"/>
                </div>
                <div class="form-group">
                    <h:outputLabel for="newDesc" value="説明（任意）" styleClass="label"/>
                    <h:inputTextarea id="newDesc"
                                     value="#{todoBean.newDescription}"
                                     placeholder="詳細説明を入力（省略可）"
                                     styleClass="textarea-field"
                                     rows="3"/>
                </div>
                <h:commandButton value="追加する"
                                 action="#{todoBean.addTodo}"
                                 styleClass="btn btn-primary"/>
            </h:form>
        </section>

        <!-- ── Todo リスト ── -->
        <section class="card list-section">
            <h2>&#128221; Todo 一覧</h2>
            <h:form id="listForm">
                <ui:repeat value="#{todoBean.todoList}" var="todo">
                    <div class="todo-item #{todo.completed ? 'item-completed' : 'item-pending'}">

                        <div class="todo-row">
                            <!-- 完了トグルボタン -->
                            <h:commandButton
                                    value="#{todo.completed ? '&#10003;' : '&#9675;'}"
                                    action="#{todoBean.toggleComplete(todo)}"
                                    styleClass="btn-toggle #{todo.completed ? 'toggle-done' : 'toggle-open'}"
                                    title="完了/未完了を切り替え"/>

                            <!-- タイトル -->
                            <span class="todo-title #{todo.completed ? 'strikethrough' : ''}">
                                #{todo.title}
                            </span>

                            <!-- アクションボタン -->
                            <div class="todo-actions">
                                <!--
                                    「詳細・編集」ボタンを押すと TodoBean#viewDetail が呼ばれ、
                                    FlashContainer に selectedTodo を格納した上で
                                    detail.xhtml へリダイレクトします。
                                -->
                                <h:commandButton value="詳細・編集"
                                                 action="#{todoBean.viewDetail(todo)}"
                                                 styleClass="btn btn-secondary"/>
                                <h:commandButton value="削除"
                                                 action="#{todoBean.deleteTodo(todo.id)}"
                                                 styleClass="btn btn-danger"
                                                 onclick="return confirm('このTodo を削除しますか？')"/>
                            </div>
                        </div>

                        <!-- 説明文 (あれば表示) -->
                        <h:panelGroup rendered="#{not empty todo.description}">
                            <p class="todo-desc">#{todo.description}</p>
                        </h:panelGroup>

                    </div>
                </ui:repeat>

                <!-- リストが空の場合 -->
                <h:panelGroup rendered="#{todoBean.todoList.empty}">
                    <p class="empty-msg">Todo がありません。上のフォームから追加してください。</p>
                </h:panelGroup>
            </h:form>
        </section>
    </div>
</h:body>
</html>
